# NATS PocketBase Sync

A Go application that synchronizes MQTT users and roles from PocketBase to NATS configuration.

## Overview

This service maintains authentication and authorization configuration for NATS MQTT by:

1. Retrieving user credentials and role permissions from PocketBase
2. Generating a properly formatted NATS configuration file with bcrypt passwords
3. Managing atomic file updates with backups
4. Triggering NATS server reloads when changes are detected

## Architecture

The application follows a clean, modular architecture with separation of concerns:

- **Configuration Management**: Loads and validates application settings
- **PocketBase Client**: Communicates with the PocketBase API
- **Config Generator**: Transforms database records into NATS configuration
- **File Manager**: Handles safe file operations with atomic writes and backups
- **NATS Reloader**: Signals the NATS server to reload its configuration

## PocketBase Schema

The application expects the following collections in PocketBase:

### mqtt_users Collection

```json
{
  "id": "string",
  "username": "string",
  "password": "string (bcrypt hashed)",
  "role_id": "string (references mqtt_roles)",
  "active": "boolean"
}
```

### mqtt_roles Collection

```json
{
  "id": "string",
  "name": "string",
  "publish_permissions": "JSON array of strings",
  "subscribe_permissions": "JSON array of strings"
}
```

**Important**: For the permission fields, use the JSON field type in PocketBase and store values as properly formatted JSON arrays:

```json
{
  "name": "READER",
  "publish_permissions": "[\"acme/bld-na-001/reader/+/event\", \"acme/bld-na-001/sensor/+/telemetry\"]",
  "subscribe_permissions": "[\"acme/bld-na-001/reader/+/+\"]"
}
```

## Configuration

Configuration is managed through a YAML file and environment variables:

```yaml
# Application configuration
app:
  sync_interval: 60 # seconds
  log_level: "info"

# PocketBase configuration
pocketbase:
  url: "http://localhost:8090"
  admin_email: "admin@example.com"
  admin_password: "your-secure-password"
  user_collection: "mqtt_users"
  role_collection: "mqtt_roles"

# NATS configuration
nats:
  config_file: "/etc/nats/mqtt-auth.conf"
  config_backup_dir: "/etc/nats/backups"
  reload_command: "nats-server --signal reload"
  default_permissions:
    publish: "PUBLIC.>"
    subscribe: ["PUBLIC.>", "_INBOX.>"]
```

Environment variables can override these settings with the format `APP_SECTION_KEY` (e.g., `APP_POCKETBASE_URL`).

## Generated NATS Configuration

The application generates a NATS configuration file that looks like:

```
# MQTT Authentication Configuration
# Auto-generated by nats-pocketbase-sync
# Generated at: 2024-03-10T14:30:00Z

authorization {
  # Default permissions applied to all users
  default_permissions = {
    publish = "PUBLIC.>"
    subscribe = ["PUBLIC.>", "_INBOX.>"]
  }

  # Role definitions
  ADMIN = {
    publish = ">"
    subscribe = ">"
  }
  READER = {
    publish = ["acme/bld-na-001/reader/+/event"]
    subscribe = ["acme/bld-na-001/reader/+/+"]
  }

  # User definitions
  users = [
    {user: "admin", password: "$2a$10$XXX...", permissions: $ADMIN},
    {user: "reader1", password: "$2a$10$YYY...", permissions: $READER}
  ]
}
```

## Building and Running

### Prerequisites

- Go 1.21 or later
- NATS Server with reload capability
- PocketBase instance with appropriate collections

### Build

```bash
go build -o nats-pocketbase-sync ./cmd/sync
```

### Run

```bash
./nats-pocketbase-sync --config=/path/to/config.yaml
```

## Docker Deployment

A Dockerfile is provided for containerized deployment:

```Dockerfile
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -o nats-pocketbase-sync ./cmd/sync

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /app
COPY --from=builder /app/nats-pocketbase-sync .
COPY config.yaml .
CMD ["./nats-pocketbase-sync"]
```

## Security Considerations

1. **Password Storage**: Passwords should be stored as bcrypt hashes in PocketBase
2. **File Permissions**: The application ensures the config file has appropriate permissions
3. **Backup Management**: Old backups are automatically cleaned up to prevent disk space issues
4. **Atomic File Updates**: Configuration updates use atomic operations to prevent partial writes

## Troubleshooting

- **Check logs**: The application uses structured logging with configurable level
- **Inspect backups**: Previous configurations are stored in the backup directory
- **Validate PocketBase connection**: Ensure the admin credentials are correct
- **Check NATS reload**: Verify the reload command is working correctly

## License

MIT License
